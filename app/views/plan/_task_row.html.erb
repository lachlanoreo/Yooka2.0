<div id="<%= dom_id(task) %>"
     class="group flex items-center gap-2 rounded-md border border-transparent bg-white px-2 py-1.5 hover:border-zinc-200 hover:shadow-sm"
     data-controller="task-row"
     data-task-row-id-value="<%= task.id %>"
     data-task-id="<%= task.id %>">
  <!-- Drag Handle -->
  <div data-drag-handle class="cursor-grab opacity-0 group-hover:opacity-100 active:cursor-grabbing">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
      <circle cx="9" cy="5" r="1.5" />
      <circle cx="15" cy="5" r="1.5" />
      <circle cx="9" cy="12" r="1.5" />
      <circle cx="15" cy="12" r="1.5" />
      <circle cx="9" cy="19" r="1.5" />
      <circle cx="15" cy="19" r="1.5" />
    </svg>
  </div>

  <!-- Checkbox -->
  <button type="button"
          class="flex h-4 w-4 shrink-0 items-center justify-center rounded border <%= task.completed? ? 'border-green-500 bg-green-500' : 'border-zinc-300 hover:border-zinc-400' %>"
          data-action="click->task-row#toggleComplete">
    <% if task.completed? %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
      </svg>
    <% end %>
  </button>

  <!-- Title -->
  <span class="flex-1 text-sm <%= task.completed? ? 'text-zinc-400 line-through' : 'text-zinc-900' %>">
    <%= task.title %>
  </span>

  <!-- Source indicator -->
  <% if task.basecamp? %>
    <span class="rounded bg-blue-100 px-1.5 py-0.5 text-xs font-medium text-blue-700">BC</span>
    <a href="<%= task.basecamp_url %>" target="_blank" rel="noopener"
       class="text-zinc-400 hover:text-blue-600" title="Open in Basecamp">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
    </a>
  <% else %>
    <span class="rounded bg-zinc-100 px-1.5 py-0.5 text-xs font-medium text-zinc-600">P</span>
  <% end %>

  <!-- Due date -->
  <% if task.personal? %>
    <!-- Editable date for personal tasks -->
    <span data-task-row-target="dateDisplay"
          data-action="click->task-row#editDate"
          class="cursor-pointer text-xs <%= task.due_date.present? && task.due_date < Date.current ? 'text-red-600 font-medium' : 'text-zinc-500' %> hover:text-zinc-700">
      <%= task.due_date.present? ? task.due_date.strftime("%-m/%-d") : "No date" %>
    </span>
    <input type="date"
           data-task-row-target="dateInput"
           data-action="change->task-row#saveDate blur->task-row#cancelDateEdit"
           value="<%= task.due_date&.to_s %>"
           class="hidden w-24 rounded border border-zinc-300 px-1 py-0.5 text-xs focus:border-amber-500 focus:outline-none">
  <% elsif task.due_date %>
    <!-- Read-only date for Basecamp tasks -->
    <span class="flex items-center gap-1 text-xs <%= task.due_date < Date.current ? 'text-red-600 font-medium' : 'text-zinc-500' %>">
      <%= task.due_date.strftime("%-m/%-d") %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="Synced from Basecamp">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
    </span>
  <% end %>

  <!-- Actions dropdown (visible on hover) -->
  <div class="relative opacity-0 group-hover:opacity-100" data-controller="dropdown">
    <button type="button"
            class="rounded p-1 text-zinc-400 hover:bg-zinc-100 hover:text-zinc-600"
            data-action="click->dropdown#toggle">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
      </svg>
    </button>
    <div data-dropdown-target="menu"
         class="absolute right-0 top-full z-10 mt-1 hidden w-32 rounded-md border border-zinc-200 bg-white py-1 shadow-lg">
      <% Task::GROUPS.each do |group| %>
        <% next if group == task.group %>
        <button type="button"
                class="block w-full px-3 py-1 text-left text-sm text-zinc-700 hover:bg-zinc-100"
                data-action="click->task-row#moveTo"
                data-group="<%= group %>">
          Move to <%= group.titleize %>
        </button>
      <% end %>
      <hr class="my-1 border-zinc-200">
      <button type="button"
              class="block w-full px-3 py-1 text-left text-sm text-red-600 hover:bg-red-50"
              data-action="click->task-row#archive">
        Archive
      </button>
    </div>
  </div>
</div>
